<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sikkim Monasteries â€“ Safe Route Planner</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Leaflet & Routing Machine -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

  <!-- jsPDF & html2canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
  #map { height: 500px; border-radius: 1rem; }
  .emoji-pin {
    font-size: 34px; /* ğŸ”¥ Bigger emoji size */
    line-height: 34px;
    text-align: center;
  }
  .leaflet-popup-content img {
    max-width: 100px;
    max-height: 80px;
    object-fit: cover;
    margin: 4px 4px 0 0;
    border-radius: 6px;
  }
 </style>

</head>
<body class="bg-gray-50 text-gray-800">

  <div class="max-w-7xl mx-auto p-6">
    <!-- Header -->
    <div class="flex justify-between items-center mb-4">
      <div>
        <h1 class="text-2xl font-bold flex items-center gap-2">
          <span class="text-red-500">ğŸ“</span> Interactive Map of Sikkim Monasteries
        </h1>
        <p class="text-gray-600">Explore monastery locations, alerts, and plan safe routes</p>
      </div>
      <div class="flex gap-2 sm:gap-4">
        <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full">12 Monasteries</span>
        <span class="bg-red-100 text-red-700 px-3 py-1 rounded-full">Live Hazards</span>
        <button id="addHazardBtnHeader" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded-lg text-sm">
  â• Add Hazard
</button>

      </div>
    </div>

 <!-- Map + Sidebar -->
    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
      <!-- Map & Planner -->
      <div class="lg:col-span-3 space-y-4">
        <div id="map"></div>

        <!-- Route Planner Panel -->
        <div class="bg-white rounded-xl shadow p-4">
          <h2 class="text-lg font-semibold mb-3">ğŸ§­ Safe Route Planner</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="space-y-2">
              <label class="text-sm text-gray-700">Start</label>
              <select id="startSelect" class="border rounded-lg px-3 py-2 w-full">
                <option value="mylocation">ğŸ“ My Location</option>
              </select>
            </div>
            <div class="space-y-2">
              <label class="text-sm text-gray-700">Destinations (multi-select)</label>
              <select id="destSelect" class="border rounded-lg px-3 py-2 w-full" multiple></select>
              <p class="text-xs text-gray-500">Tip: Hold Ctrl/Cmd to pick multiple.</p>
            </div>
          </div>

          <div class="mt-3 flex flex-wrap gap-3 items-center">
            <label class="inline-flex items-center gap-2 text-sm">
              <input id="avoidHazards" type="checkbox" class="rounded border-gray-300">
              Avoid hazard zones
            </label>
            <button id="planBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">Plan Safe Route</button>
            <button id="clearRouteBtn" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg">Clear Route</button>
            <button id="pdfBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg">Download PDF</button>
            
          </div>

          <div id="routeSummary" class="mt-4 text-sm text-gray-700 hidden"></div>
        </div>
      </div>

      <!-- Sidebar: Alerts + Legend -->
      <div>
        <h2 class="font-semibold text-lg mb-2 flex items-center gap-2 text-red-600">âš ï¸ Travel Alerts</h2>
        <div id="alertsList" class="space-y-3">
          <!-- Alerts are rendered from hazards[] defaults -->
        </div>

        <div class="mt-6 p-4 bg-white rounded-lg shadow">
          <h3 class="font-semibold mb-2">Map Legend</h3>
          <ul class="text-sm space-y-1">
            <li>ğŸ›• Monastery</li>
            <li>ğŸŸ¢ Start â€¢ ğŸ”µ Stop</li>
            <li>âš ï¸ Landslide â€¢ ğŸš§ Road Closed â€¢ ğŸŒŠ Flood â€¢ â„ï¸ Snow â€¢ ğŸ”¥ Fire</li>
            <li><span class="inline-block w-3 h-3 rounded-full bg-red-500 align-middle"></span> Hazard radius</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <div class="mt-10 flex flex-wrap gap-4 items-center">
      <input type="text" id="searchInput" placeholder="Search monasteries..." class="border rounded-lg px-4 py-2 w-full sm:w-64">
      <select id="filterSelect" class="border rounded-lg px-4 py-2">
        <option value="">Filter by Tradition</option>
        <option value="Nyingma">Nyingma</option>
        <option value="Kagyu">Kagyu</option>
        <option value="Zurmang Kagyu">Zurmang Kagyu</option>
        <option value="Multi-traditional">Multi-traditional</option>
      </select>
      <select id="sortSelect" class="border rounded-lg px-4 py-2">
        <option value="">Sort by</option>
        <option value="altitudeHigh">Altitude: High â†’ Low</option>
        <option value="altitudeLow">Altitude: Low â†’ High</option>
        <option value="yearOld">Oldest â†’ Newest</option>
        <option value="yearNew">Newest â†’ Oldest</option>
      </select>
    </div>

    <!-- Monastery Cards -->
    <div class="mt-8">
      <h2 class="text-2xl font-bold mb-6">Explore Monasteries</h2>
      <div id="cardsContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </div>

    <!-- Weather + Tips the last one card  -->
    
    <div class="mt-12 grid grid-cols-1 md:grid-cols-2 gap-6">
    <div class="bg-white rounded-xl shadow p-6">
    <h2 class="text-xl font-bold mb-2">ğŸŒ¤ï¸ Weather</h2>

    <!-- Dropdown for cities -->
    <select id="weatherSelect" class="border rounded-lg px-3 py-2 mb-4 w-full">
      <option value="Gangtok">Gangtok</option>
      <option value="Pelling">Pelling</option>
      <option value="Namchi">Namchi</option>
      <option value="Yuksom">Yuksom</option>
    </select>

    <p>Temperature: <span id="weatherTemp" class="font-semibold">18Â°C</span></p>
    <p>Condition: <span id="weatherCond" class="font-semibold">Clear Sky</span></p>
    <p>Humidity: <span id="weatherHum" class="font-semibold">60%</span></p>
  </div>

      
  
  <div class="bg-white rounded-xl shadow p-6">
        <h2 class="text-xl font-bold mb-2">ğŸ§³ Travel Tips</h2>
        <ul class="list-disc list-inside text-gray-600 space-y-1">
          <li>Best time: Marchâ€“May, Octoberâ€“December</li>
          <li>Some areas need permits (foreign visitors)</li>
          <li>Weather changes quickly â€” carry warm layers</li>
          <li>Cash recommended in remote regions</li>
        </ul>
      </div>
    </div>

    <!-- Footer -->
    <footer class="mt-12 border-t pt-6 text-center text-sm text-gray-500">
      Â© 2025 Sikkim Monasteries Map | Educational Demo
    </footer>
  </div>

<!-- Hazard Modal -->
<div id="hazardModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:50; justify-content:center; align-items:center; padding:1rem;">
  <div style="background:white; width:100%; max-width:600px; border-radius:1rem; box-shadow:0 10px 25px rgba(0,0,0,0.2); padding:1.5rem;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
      <h3 style="font-size:1.125rem; font-weight:600;">â• Report Hazard</h3>
      <button id="closeHazardModal" style="color:#6b7280; cursor:pointer;">âœ–</button>
    </div>

    <!-- Form content -->
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem;">
      <div>
        <label style="font-size:0.875rem; color:#374151;">Hazard Type</label>
        <select id="hazardType" style="border-radius:0.5rem; padding:0.5rem; width:100%; border:1px solid #d1d5db;">
          <option value="âš ï¸ Landslide">âš ï¸ Landslide</option>
          <option value="ğŸš§ Road Closed">ğŸš§ Road Closed</option>
          <option value="ğŸŒŠ Flood">ğŸŒŠ Flood</option>
          <option value="â„ï¸ Snow/Ice">â„ï¸ Snow/Ice</option>
          <option value="ğŸ”¥ Fire">ğŸ”¥ Fire</option>
        </select>
      </div>
      <div>
        <label style="font-size:0.875rem; color:#374151;">Radius (meters)</label>
        <input id="hazardRadius" type="number" value="600" min="100" step="50" style="border-radius:0.5rem; padding:0.5rem; width:100%; border:1px solid #d1d5db;">
      </div>
      <div style="grid-column:span 2;">
        <label style="font-size:0.875rem; color:#374151;">Description (optional)</label>
        <input id="hazardDesc" type="text" placeholder="Short description..." style="border-radius:0.5rem; padding:0.5rem; width:100%; border:1px solid #d1d5db;">
      </div>
      <div style="grid-column:span 2;">
        <label style="font-size:0.875rem; color:#374151;">Upload Photos (multiple)</label>
        <input id="hazardPhotos" type="file" multiple style="width:100%;">
      </div>
    </div>

    <p style="font-size:0.75rem; color:#6b7280; margin-top:0.75rem;">ğŸ“ Tip: After pressing â€œPlace on Mapâ€, click on the map to set the hazard location.</p>

    <div style="margin-top:1rem; display:flex; justify-content:flex-end; gap:0.5rem;">
      <button id="placeHazardBtn" style="background-color:#dc2626; color:white; padding:0.5rem 1rem; border-radius:0.5rem;">Place on Map</button>
    </div>
  </div>
</div>




  <script>
    /* ----------------------------
       DATA: Monasteries + Cards
    -----------------------------*/
    const monasteryData = [
      { key: "Rumtek", name: "Rumtek Monastery", tradition: "Kagyu", altitude: 1550, year: 1966, desc: "Largest monastery in Sikkim, seat of the 16th Karmapa.", img: "https://www.tourmyindia.com/states/sikkim/images/rumtek1.jpg", coords: [27.3176, 88.6122] },
      { key: "Pemayangtse", name: "Pemayangtse Monastery", tradition: "Nyingma", altitude: 2085, year: 1705, desc: "Among the oldest; stunning views of Kanchenjunga.", img: "https://s7ap1.scene7.com/is/image/incredibleindia/pemayangtse-monastery-pelling-sikkim-2-attr-hero?qlt=82&ts=1726656027807,2", coords: [27.3064, 88.2396] },
      { key: "Tashiding", name: "Tashiding Monastery", tradition: "Nyingma", altitude: 1465, year: 1641, desc: "Sacred site; believed to cleanse sins of devotees.", img: "https://s7ap1.scene7.com/is/image/incredibleindia/spiritual-spots-in-pelling-popular?qlt=82&ts=1726655959297,3", coords: [27.2994, 88.2326] },
      { key: "Enchey", name: "Enchey Monastery", tradition: "Nyingma", altitude: 1980, year: 1909, desc: "Known for vibrant Cham dance festival.", img: "https://live.staticflickr.com/402/19521457086_65b6ff9f6b_b.jpg,4", coords: [27.3418, 88.6227] },
      { key: "Ralong", name: "Ralong Monastery", tradition: "Kagyu", altitude: 2100, year: 1730, desc: "Built to commemorate the 4th Chogyalâ€™s victory.", img: "https://holidays.tripfactory.com/sikkim/wp-content/uploads/sites/18/2024/11/Ralong-Monastery.webp,5", coords: [27.3032, 88.3628] },
      { key: "Phodong", name: "Phodong Monastery", tradition: "Kagyu", altitude: 1500, year: 1740, desc: "Ancient murals & annual Cham dance.", img: "https://www.hlimg.com/images/things2do/738X538/ttd_1523425949m1.jpg?w=400&dpr=2.6,6", coords: [27.4209, 88.5904] },
      { key: "Phensang", name: "Phensang Monastery", tradition: "Kagyu", altitude: 1560, year: 1721, desc: "Festival held before Sikkimese New Year.", img: "https://media1.thrillophilia.com/filestore/puil20n60h8emomhi7qokxljttqb_thrangutaraabbey.jpg?w=400&dpr=2,7", coords: [27.4315, 88.6140] },
      { key: "Lingdum", name: "Lingdum (Ranka) Monastery", tradition: "Zurmang Kagyu", altitude: 1675, year: 1999, desc: "Modern complex with ornate architecture.", img: "https://www.trodly.com/pictures/attraction/5590.jpg,8", coords: [27.3437, 88.6820] },
      { key: "ZangDhokPalri", name: "Zang Dhok Palri Monastery", tradition: "Multi-traditional", altitude: 1400, year: 2006, desc: "Buddha Park with 130-ft statue.", img: "https://vushii.com/uploads/340018677_Zang%20Dhok%20Palri%20Monastery.jpg,9", coords: [27.3085, 88.3640] },
      { key: "Dubdi", name: "Dubdi Monastery", tradition: "Nyingma", altitude: 1800, year: 1701, desc: "â€œHermitâ€™s Cellâ€, considered the oldest in Sikkim.", img: "https://s7ap1.scene7.com/is/image/incredibleindia/spiritual-spots-in-pelling-popular?qlt=82&ts=1726655959297,10", coords: [27.3782, 88.2200] },
      { key: "Kartok", name: "Kartok Monastery", tradition: "Nyingma", altitude: 1450, year: 1840, desc: "Picturesque Yuksom monastery with prayer wheels.", img: "https://www.travellersofindia.com/wp-content/uploads/2020/10/Places_to_Visit_in_Pemayangtse_Monastery_Travellersofindia.jpg,11", coords: [27.3730, 88.2530] },
      { key: "Zurmang", name: "Zurmang Monastery", tradition: "Zurmang Kagyu", altitude: 1675, year: 1999, desc: "Gardens, murals & peaceful ambience.", img: "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQkaCZ_OQ8_F4nOP5uAqLux5tWeRnW3oIKzJg&s,12", coords: [27.3600, 88.6800] }
    ];

    /* ----------------------------
       MAP: Init + Monastery Pins
    -----------------------------*/
    const map = L.map('map').setView([27.33, 88.55], 9);
    const tiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors',
      crossOrigin: true
    }).addTo(map);

    const monasteryIcon = (emoji = 'ğŸ›•') => L.divIcon({ className: 'emoji-pin', html: emoji, iconSize: [24, 24] });
    const startIcon = L.divIcon({ className: 'emoji-pin', html: 'ğŸŸ¢', iconSize: [24, 24] });
    const stopIcon = L.divIcon({ className: 'emoji-pin', html: 'ğŸ”µ', iconSize: [24, 24] });

    const monasteryLayer = L.layerGroup().addTo(map);
    const keyToLatLng = {};
    monasteryData.forEach(m => {
      keyToLatLng[m.key] = L.latLng(m.coords[0], m.coords[1]);
      L.marker(m.coords, { icon: monasteryIcon('ğŸ›•') }).addTo(monasteryLayer).bindPopup(`<b>${m.name}</b><br>${m.tradition}`);
    });

    /* ----------------------------
       HAZARDS: Defaults + UI
    -----------------------------*/
    const hazardLayer = L.layerGroup().addTo(map);
    let hazards = []; // { id, type, desc, latlng, radius, photos[], marker, circle, removable }
    let nextHazardId = 1;

    // Preload some hazards (alerts)
    const defaultHazards = [
      { type: 'âš ï¸ Landslide', desc: 'Mangan Road Block â€“ High risk', latlng: L.latLng(27.62, 88.59), radius: 900 },
      { type: 'ğŸš§ Road Closed', desc: 'Nathula Pass seasonal closure', latlng: L.latLng(27.39, 88.83), radius: 1200 },
      { type: 'ğŸŒŠ Flood', desc: 'Teesta flood risk zone', latlng: L.latLng(27.33, 88.55), radius: 800 },
      { type: 'âš ï¸ Landslide', desc: 'Yumthang Valley access issue', latlng: L.latLng(27.79, 88.69), radius: 900 }
    ];
    defaultHazards.forEach(h => addHazardToMap({ ...h, photos: [], removable: false }));

    function hazardEmoji(type) {
      if (type.startsWith('âš ï¸')) return 'âš ï¸';
      if (type.startsWith('ğŸš§')) return 'ğŸš§';
      if (type.startsWith('ğŸŒŠ')) return 'ğŸŒŠ';
      if (type.startsWith('â„ï¸')) return 'â„ï¸';
      if (type.startsWith('ğŸ”¥')) return 'ğŸ”¥';
      return 'âš ï¸';
    }



     function addHazardToMap(h) {
     const id = nextHazardId++;
     const emoji = hazardEmoji(h.type);

      // âœ… Bigger emoji for hazard
     const marker = L.marker(h.latlng, {
     icon: L.divIcon({
      className: 'emoji-pin',
      html: emoji,
      iconSize: [40, 40]  // bigger emoji marker
     })
     }).addTo(hazardLayer);

     const circle = L.circle(h.latlng, {
     radius: h.radius * 3,   // ğŸ”¥ Make radius 3x bigger
     color: 'red',
     weight: 1.5,
     fillColor: '#f87171',
     fillOpacity: 0.25
     }).addTo(hazardLayer);


     let html = `<b>${h.type}</b><br>${h.desc || ''}<br>`;
     if (h.photos && h.photos.length) {
      h.photos.forEach(src => { html += `<img src="${src}">`; });
     }
     if (h.removable) {
     html += `<div class="mt-2">
      <button onclick="window.__removeHazard(${id})"
        class="bg-red-600 text-white text-xs px-2 py-1 rounded">Remove</button>
       </div>`;
      }
     marker.bindPopup(html);

      // âœ… Center popup automatically when hazard is added
     marker.openPopup();
     map.setView(h.latlng, 11, { animate: true });

     const hazardObj = {
     id,
     type: h.type,
     desc: h.desc || '',
     latlng: h.latlng,
     radius: h.radius,
     photos: h.photos || [],
     marker,
     circle,
     removable: !!h.removable
     };
     hazards.push(hazardObj);
     renderAlerts();
     return hazardObj;
     }


    

     window.__removeHazard = function(id) {
      const idx = hazards.findIndex(h => h.id === id);
      if (idx >= 0) {
        map.removeLayer(hazards[idx].marker);
        map.removeLayer(hazards[idx].circle);
        hazards.splice(idx, 1);
        renderAlerts();
      }
     };

     function renderAlerts() {
      const list = document.getElementById('alertsList');
      list.innerHTML = '';
      hazards.forEach(h => {
        const li = document.createElement('div');
        li.className = 'p-4 bg-white rounded-lg shadow border-l-4 ' + (h.type.startsWith('âš ï¸') || h.type.startsWith('ğŸ”¥') ? 'border-red-500' : h.type.startsWith('ğŸš§') ? 'border-yellow-500' : 'border-blue-500');
        li.innerHTML = `<div class="flex items-start justify-between gap-3">
          <div>
            <h3 class="font-bold">${h.type}</h3>
            <p class="text-sm text-gray-600">${h.desc}</p>
            <p class="text-xs text-gray-500 mt-1">Radius ~ ${Math.round(h.radius)} m</p>
          </div>
          ${h.removable ? `<button class="text-xs text-red-600 hover:underline" onclick="window.__removeHazard(${h.id})">Remove</button>`:''}
        </div>`;
        list.appendChild(li);
      });
    }

    // Hazard Modal interactions
const hazardModal = document.getElementById('hazardModal');


document.getElementById('addHazardBtnHeader').addEventListener('click', () => {
  document.getElementById('hazardModal').style.display = 'flex';
});


document.getElementById('closeHazardModal').addEventListener('click', () => {
  hazardModal.style.display = 'none';
});


hazardModal.addEventListener('click', (e) => {
  if (e.target === hazardModal) {
    hazardModal.style.display = 'none';
  }
});

let placingHazard = false;


document.getElementById('placeHazardBtn').addEventListener('click', () => {
  placingHazard = true;
  hazardModal.style.display = 'none'; 
  alert("Now click on the map to place the hazard");
});


map.on('click', e => {
  if (!placingHazard) return;
  placingHazard = false;

  const type = document.getElementById('hazardType').value;
  const desc = document.getElementById('hazardDesc').value;
  const radius = Math.max(100, Number(document.getElementById('hazardRadius').value) || 600);
  const files = document.getElementById('hazardPhotos').files;
  const photos = [];
  for (const f of files) photos.push(URL.createObjectURL(f));

  addHazardToMap({ type, desc, latlng: e.latlng, radius, photos, removable: true });
});


    /* ----------------------------
       CARDS: Search/Filter/Sort
    -----------------------------*/
    function renderCards(list) {
      const container = document.getElementById('cardsContainer');
      container.innerHTML = '';
      list.forEach(m => {
        container.innerHTML += `
          <div class="bg-white rounded-2xl shadow overflow-hidden">
            <div class="relative">
              <img src="${m.img}" class="w-full h-48 object-cover" alt="${m.name}">
              <span class="absolute top-3 right-3 bg-white text-gray-800 text-xs font-medium px-2 py-1 rounded-full shadow">${m.altitude}m</span>
              <span class="absolute bottom-3 left-3 bg-white/80 text-gray-700 text-xs font-medium px-2 py-1 rounded">${m.tradition}</span>
            </div>
            <div class="p-4">
              <h3 class="font-semibold text-lg">${m.name}</h3>
              <p class="text-sm text-gray-600">${m.desc}</p>
            </div>
            <div class="flex justify-between items-center px-4 py-3 border-t text-sm">
              <span class="text-gray-500">ğŸ“… Est. ${m.year}</span>
              <a href="360.html" class="text-green-600 font-medium hover:underline">Virtual Tour â†’</a>
            </div>
          </div>`;
      });
    }
    renderCards(monasteryData);

    document.getElementById('searchInput').addEventListener('input', filterMonasteries);
    document.getElementById('filterSelect').addEventListener('change', filterMonasteries);
    document.getElementById('sortSelect').addEventListener('change', filterMonasteries);

    function filterMonasteries() {
      let list = [...monasteryData];
      const search = document.getElementById('searchInput').value.toLowerCase();
      const filter = document.getElementById('filterSelect').value;
      const sort = document.getElementById('sortSelect').value;

      if (search) list = list.filter(m => m.name.toLowerCase().includes(search));
      if (filter) list = list.filter(m => m.tradition === filter);
      if (sort === 'altitudeHigh') list.sort((a,b)=>b.altitude-a.altitude);
      if (sort === 'altitudeLow') list.sort((a,b)=>a.altitude-b.altitude);
      if (sort === 'yearOld') list.sort((a,b)=>a.year-b.year);
      if (sort === 'yearNew') list.sort((a,b)=>b.year-a.year);

      renderCards(list);
    }

    /* ----------------------------
       ROUTE PLANNER
    -----------------------------*/
    // Populate planner selects
    const startSel = document.getElementById('startSelect');
    const destSel = document.getElementById('destSelect');
    monasteryData.forEach(m => {
      const opt1 = document.createElement('option'); opt1.value = m.key; opt1.textContent = `ğŸ›• ${m.name}`;
      startSel.appendChild(opt1);
      const opt2 = document.createElement('option'); opt2.value = m.key; opt2.textContent = `ğŸ›• ${m.name}`;
      destSel.appendChild(opt2);
    });

    let routingControl = null;
    let latestRoute = null;
    let userStartMarker = null;

    function getLatLngForKey(key) { return keyToLatLng[key]; }

    function getGeoLocation() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) return reject(new Error('Geolocation not supported'));
        navigator.geolocation.getCurrentPosition(
          pos => resolve(L.latLng(pos.coords.latitude, pos.coords.longitude)),
          err => reject(err),
          { enableHighAccuracy: true, timeout: 8000 }
        );
      });
    }

    // Simple geometry helpers (meters <> degrees)
    function metersToDegLat(m) { return m / 111320; }
    function metersToDegLng(m, lat) { return m / (111320 * Math.cos(lat * Math.PI/180)); }

    // Distance from point C to segment AB (approx degrees treated as planar in small region)
    function distPointToSegment(c, a, b) {
      const A = [a.lat, a.lng], B = [b.lat, b.lng], C = [c.lat, c.lng];
      const AB = [B[0]-A[0], B[1]-A[1]];
      const AC = [C[0]-A[0], C[1]-A[1]];
      const ab2 = AB[0]*AB[0] + AB[1]*AB[1];
      const t = Math.max(0, Math.min(1, ab2 ? (AC[0]*AB[0]+AC[1]*AB[1])/ab2 : 0));
      const D = [A[0]+AB[0]*t, A[1]+AB[1]*t];
      const dx = C[0]-D[0], dy = C[1]-D[1];
      // Convert deg diff to meters approx
      const mPerDegLat = 111320;
      const mPerDegLng = 111320 * Math.cos(c.lat * Math.PI/180);
      return Math.sqrt( (dx*mPerDegLat)**2 + (dy*mPerDegLng)**2 );
    }

    function computeDetourPoint(a, b, hazard) {
      // pick a perpendicular direction to AB, at hazard center, outside the circle + buffer
      const buffer = 250; // meters extra
      const needed = hazard.radius + buffer;
      const AB = { x: b.lng - a.lng, y: b.lat - a.lat };
      // Perp vectors
      const P1 = { x: -AB.y, y: AB.x };
      const P2 = { x: AB.y, y: -AB.x };
      const norm = (p) => Math.sqrt(p.x*p.x + p.y*p.y) || 1;
      const p1 = { x: P1.x / norm(P1), y: P1.y / norm(P1) };
      const p2 = { x: P2.x / norm(P2), y: P2.y / norm(P2) };

      // Convert meters offset to degrees at hazard lat
      const dLat = metersToDegLat(needed);
      const dLng = metersToDegLng(needed, hazard.latlng.lat);

      // Two candidate detours left/right of hazard center
      const cand1 = L.latLng(hazard.latlng.lat + p1.y * dLat, hazard.latlng.lng + p1.x * dLng);
      const cand2 = L.latLng(hazard.latlng.lat + p2.y * dLat, hazard.latlng.lng + p2.x * dLng);

      // Choose farther from other hazards (simple heuristic)
      const otherHaz = hazards.filter(h => h.id !== hazard.id);
      const score = (pt) => otherHaz.reduce((min, h) => Math.min(min, map.distance(pt, h.latlng) - h.radius), 1e9);
      return score(cand1) >= score(cand2) ? cand1 : cand2;
    }

    async function planRoute() {
      document.getElementById('routeSummary').classList.add('hidden');
      latestRoute = null;

      // Build waypoints
      let waypoints = [];
      const startVal = startSel.value;
      let startLatLng;

      if (startVal === 'mylocation') {
        try {
          startLatLng = await getGeoLocation();
        } catch(e) {
          alert('Could not get your location. Using Rumtek as start.');
          startLatLng = getLatLngForKey('Rumtek');
        }
      } else {
        startLatLng = getLatLngForKey(startVal);
      }
      waypoints.push(L.latLng(startLatLng));

      // Marker for start
      if (userStartMarker) map.removeLayer(userStartMarker);
      userStartMarker = L.marker(startLatLng, { icon: startIcon }).addTo(map).bindPopup('ğŸŸ¢ Start');

      const selected = Array.from(destSel.selectedOptions).map(o => o.value);
      selected.forEach(k => waypoints.push(L.latLng(getLatLngForKey(k))));

      // If "avoid hazards" is checked, inject detour points where segment intersects hazard circle
      if (document.getElementById('avoidHazards').checked) {
        waypoints = injectDetours(waypoints);
      }

      if (routingControl) { map.removeControl(routingControl); routingControl = null; }

      routingControl = L.Routing.control({
        waypoints,
        routeWhileDragging: false,
        addWaypoints: false,
        showAlternatives: false,
        lineOptions: { styles: [{ color: '#2563eb', weight: 5, opacity: 0.9 }] },
        createMarker: function(i, wp, n) {
          if (i === 0) return L.marker(wp.latLng, { icon: startIcon }).bindPopup('ğŸŸ¢ Start');
          if (i === n-1) return L.marker(wp.latLng, { icon: stopIcon }).bindPopup('ğŸ”µ Destination');
          return L.marker(wp.latLng, { icon: monasteryIcon('ğŸ”µ') }).bindPopup('ğŸ”µ Stop');
        }
      }).addTo(map);

      routingControl.on('routesfound', e => {
        latestRoute = e.routes[0];
        const km = (latestRoute.summary.totalDistance / 1000).toFixed(1);
        const mins = Math.round(latestRoute.summary.totalTime / 60);
        document.getElementById('routeSummary').innerHTML = `<b>Route planned:</b> ${km} km â€¢ ~${mins} min`;
        document.getElementById('routeSummary').classList.remove('hidden');
      });

      routingControl.on('routingerror', () => {
        alert('Unable to compute route with current waypoints.');
      });
    }

    function injectDetours(pts) {
      if (pts.length < 2) return pts;
      const detoured = [pts[0]];
      for (let i = 0; i < pts.length - 1; i++) {
        const a = pts[i], b = pts[i+1];
        const offenders = hazards.filter(h => distPointToSegment(h.latlng, a, b) < (h.radius + 150));
        if (offenders.length) {
          offenders.forEach(h => {
            const detour = computeDetourPoint(a, b, h);
            detoured.push(detour);
          });
        }
        detoured.push(b);
      }
      return detoured;
    }

    document.getElementById('planBtn').addEventListener('click', planRoute);
    document.getElementById('clearRouteBtn').addEventListener('click', () => {
      if (routingControl) { map.removeControl(routingControl); routingControl = null; }
      document.getElementById('routeSummary').classList.add('hidden');
    });

    /* ----------------------------
       PDF EXPORT (map + route + risks)
    -----------------------------*/
    async function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: 'pt', format: 'a4' });
      const pageW = doc.internal.pageSize.getWidth();
      let y = 40;

      // Header
      doc.setFont('helvetica', 'bold'); doc.setFontSize(16);
      doc.text('ğŸ›• Sikkim Monastery Safe Route Planner', 40, y);
      y += 20;
      doc.setFont('helvetica', 'normal'); doc.setFontSize(11);
      const dateStr = new Date().toLocaleString();
      doc.text(`Generated: ${dateStr}`, 40, y); y += 18;

      // Map snapshot
      try {
        const canvas = await html2canvas(document.getElementById('map'), { useCORS: true, allowTaint: true, backgroundColor: '#f8fafc' });
        const img = canvas.toDataURL('image/png');
        const imgW = pageW - 80, imgH = (canvas.height / canvas.width) * imgW;
        doc.addImage(img, 'PNG', 40, y, imgW, Math.min(imgH, 280));
        y += Math.min(imgH, 280) + 16;
      } catch (e) {
        doc.text('ğŸ–¼ï¸ Map snapshot unavailable (browser blocked cross-origin tiles).', 40, y);
        y += 16;
      }

      // Route details
      doc.setFont('helvetica', 'bold'); doc.text('ğŸ›£ï¸ Route Details', 40, y); y += 16;
      doc.setFont('helvetica', 'normal');
      if (latestRoute) {
        const km = (latestRoute.summary.totalDistance/1000).toFixed(1);
        const mins = Math.round(latestRoute.summary.totalTime/60);
        doc.text(`Distance: ${km} km â€¢ Time: ~${mins} min`, 40, y); y += 14;

        // Instructions (if available)
        if (latestRoute.instructions && latestRoute.instructions.length) {
          doc.setFont('helvetica', 'bold'); doc.text('Directions:', 40, y); y += 14;
          doc.setFont('helvetica', 'normal');
          latestRoute.instructions.slice(0, 60).forEach((inst, idx) => {
            const txt = `${idx+1}. ${inst.text || inst.message || ''} (${Math.round(inst.distance)} m)`;
            const split = doc.splitTextToSize(txt, pageW - 80);
            if (y + split.length*12 > 780) { doc.addPage(); y = 40; }
            doc.text(split, 40, y); y += split.length*12 + 4;
          });
        } else {
          doc.text('Step-by-step directions not available from the router; showing summary only.', 40, y); y += 14;
        }
      } else {
        doc.text('No active route. Use the planner to create a route first.', 40, y); y += 14;
      }

      // Hazards list
      if (y > 720) { doc.addPage(); y = 40; }
      doc.setFont('helvetica', 'bold'); doc.text('âš ï¸ Risk Report (current hazards)', 40, y); y += 16;
      doc.setFont('helvetica', 'normal');
      if (!hazards.length) {
        doc.text('No hazards on record.', 40, y); y += 14;
      } else {
        hazards.forEach(h => {
          const line = `${hazardEmoji(h.type)} ${h.type} â€” ${h.desc} â€¢ Radius ~ ${Math.round(h.radius)} m`;
          const split = doc.splitTextToSize(line, pageW - 80);
          if (y + split.length*12 > 780) { doc.addPage(); y = 40; }
          doc.text(split, 40, y); y += split.length*12 + 4;
        });
      }

      doc.save('sikkim-safe-route.pdf');
     }
     document.getElementById('pdfBtn').addEventListener('click', downloadPDF);


// â† PASTE YOUR WEATHER DROPDOWN JS HERE

// Simple weather data (replace with API later)
const weatherData = {
  Gangtok: { temp: "18Â°C", cond: "Clear Sky", hum: "60%" },
  Pelling: { temp: "15Â°C", cond: "Partly Cloudy", hum: "65%" },
  Namchi: { temp: "20Â°C", cond: "Sunny", hum: "55%" },
  Yuksom: { temp: "14Â°C", cond: "Foggy", hum: "70%" }
};

document.getElementById('weatherSelect').addEventListener('change', function() {
  const city = this.value;
  const data = weatherData[city];
  document.getElementById('weatherTemp').textContent = data.temp;
  document.getElementById('weatherCond').textContent = data.cond;
  document.getElementById('weatherHum').textContent = data.hum;
});



 
  </script>
</body>
</html>
